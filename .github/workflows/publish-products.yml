name: Publish Products JSON
on:
  push:
    paths:
      - 'products.json'
    branches: [ main ]  # Cambia si tu rama por defecto es otra
permissions:
  contents: write
jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Create versioned JSON files
        run: |
          node -e "
          import { promises as fs } from 'fs';
          import path from 'path';
          const ROOT = process.cwd();
          const SRC_FILE = path.join(ROOT, 'products.json');
          const OUT_DIR  = path.join(ROOT, 'Productos');
          const run = async () => {
            const raw = await fs.readFile(SRC_FILE, 'utf8');
            const products = JSON.parse(raw);
            await fs.mkdir(OUT_DIR, { recursive: true });
            const files = await fs.readdir(OUT_DIR).catch(()=>[]);
            const nums = files.map(f => (f.match(/^productos-(\d+)\.json$/i)?.[1]))
                              .filter(Boolean).map(n => parseInt(n,10));
            const next = (nums.length ? Math.max(...nums) : 0) + 1;
            const outName = `productos-${next}.json`;
            await fs.writeFile(path.join(OUT_DIR, outName), JSON.stringify(products, null, 2));
            const latest = { url: `Productos/${outName}`, version: next, updatedAt: new Date().toISOString() };
            await fs.writeFile(path.join(OUT_DIR, 'latest.json'), JSON.stringify(latest, null, 2));
            console.log('Generated', outName, 'and updated latest.json');
          };
          run().catch(e => { console.error(e); process.exit(1); });
          "

      - name: Commit artifacts
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add Productos/
          git commit -m "ci: publish products json" || echo "No changes to commit"
          git push
